var st={sel:null,n:4,name:'slice-1',nodes:new vis.DataSet(),edges:new vis.DataSet(),cur:null,net:null,edgeStates:{}};
var fm={'f1':{cores:1,disk_gb:10,ram_gb:2},'f2':{cores:1,disk_gb:10,ram_gb:4},'f3':{cores:2,disk_gb:10,ram_gb:2},'f4':{cores:2,disk_gb:10,ram_gb:4}};
var tp={
  anillo:function(n){var ns=[],es=[];var angleStep=2*Math.PI/n;for(var i=0;i<n;i++){var angle=i*angleStep;var x=300*Math.cos(angle);var y=300*Math.sin(angle);ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true},x:x,y:y,fixed:true,physics:false});es.push({id:'edge-'+i+'-'+((i+1)%n),from:i,to:(i+1)%n,smooth:{type:'curvedCW',roundness:0.2}})}return{nodes:ns,edges:es}},
  arbol:function(n){var ns=[],es=[];var levels=Math.ceil(Math.log2(n+1));for(var i=0;i<n;i++){var level=Math.floor(Math.log2(i+1));var posInLevel=i-Math.pow(2,level)+1;var totalInLevel=Math.pow(2,level);var x=(posInLevel+0.5)*(600/totalInLevel)-300;var y=level*150-200;ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true},x:x,y:y,fixed:true,physics:false});if(i>0){var parent=Math.floor((i-1)/2);es.push({id:'edge-'+parent+'-'+i,from:parent,to:i,smooth:{type:'curvedCW',roundness:0.2}})}}return{nodes:ns,edges:es}},
  malla:function(n){var ns=[],es=[];var cols=Math.ceil(Math.sqrt(n));var rows=Math.ceil(n/cols);var edgeId=0;for(var i=0;i<n;i++){var row=Math.floor(i/cols);var col=i%cols;var x=(col-(cols-1)/2)*150;var y=(row-(rows-1)/2)*150;ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true},x:x,y:y,fixed:true,physics:false});for(var j=i+1;j<n;j++){es.push({id:'edge-'+i+'-'+j,from:i,to:j,smooth:{type:'curvedCW',roundness:0.2}})}}return{nodes:ns,edges:es}},
  estrella:function(n){var ns=[],es=[];ns.push({id:0,label:'üíª\nnode-0',configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true},x:0,y:0,fixed:true,physics:false});var angleStep=2*Math.PI/(n-1);for(var i=1;i<n;i++){var angle=(i-1)*angleStep;var x=250*Math.cos(angle);var y=250*Math.sin(angle);ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true},x:x,y:y,fixed:true,physics:false});es.push({id:'edge-0-'+i,from:0,to:i,smooth:{type:'curvedCW',roundness:0.2}})}return{nodes:ns,edges:es}}
};
document.getElementById('topologySelect').addEventListener('change',function(){st.sel=this.value});
document.getElementById('addTopologyBtn').addEventListener('click',function(){st.sel=document.getElementById('topologySelect').value;if(!st.sel){alert('Selecciona una topolog√≠a');return}st.n=parseInt(document.getElementById('numNodes').value);st.name=document.getElementById('sliceName').value||'slice-1';var t=tp[st.sel](st.n);st.nodes.clear();st.edges.clear();st.edgeStates={};st.nodes.add(t.nodes);st.edges.add(t.edges);t.edges.forEach(function(e){st.edgeStates[e.id]={direction:'curvedCW',roundness:0.2}});if(!st.net){var c=document.getElementById('network');st.net=new vis.Network(c,{nodes:st.nodes,edges:st.edges},{nodes:{shape:'box',size:30,font:{size:14,color:'#1e293b',multi:true},borderWidth:3,borderWidthSelected:4,margin:{top:8,bottom:8,left:10,right:10}},edges:{width:3,color:{color:'#94a3b8',highlight:'#64748b'},smooth:{enabled:true,type:'curvedCW',roundness:0.2}},physics:{enabled:false},interaction:{hover:true,tooltipDelay:200,dragNodes:false,dragView:false,zoomView:true}});st.net.on('click',function(p){if(p.nodes.length>0)openM(p.nodes[0])});var canvas=c.querySelector('canvas');var isDragging=false;var draggedEdge=null;canvas.addEventListener('mousedown',function(e){var pos=st.net.DOMtoCanvas({x:e.offsetX,y:e.offsetY});var nearestEdge=findNearestEdge(pos);if(nearestEdge){isDragging=true;draggedEdge=nearestEdge;canvas.style.cursor='grab'}});canvas.addEventListener('mousemove',function(e){if(isDragging&&draggedEdge){canvas.style.cursor='grabbing';var pos=st.net.DOMtoCanvas({x:e.offsetX,y:e.offsetY});var edge=st.edges.get(draggedEdge);var fromPos=st.net.getPosition(edge.from);var toPos=st.net.getPosition(edge.to);var mx=(fromPos.x+toPos.x)/2;var my=(fromPos.y+toPos.y)/2;var dx=toPos.x-fromPos.x;var dy=toPos.y-fromPos.y;var len=Math.sqrt(dx*dx+dy*dy);var nx=-dy/len;var ny=dx/len;var pdx=pos.x-mx;var pdy=pos.y-my;var offset=pdx*nx+pdy*ny;var direction=offset>=0?'curvedCCW':'curvedCW';var roundness=Math.abs(offset)/len;roundness=Math.max(0.1,Math.min(roundness,2));st.edgeStates[draggedEdge]={direction:direction,roundness:roundness};st.edges.update({id:draggedEdge,smooth:{enabled:true,type:direction,roundness:roundness}})}});canvas.addEventListener('mouseup',function(){isDragging=false;draggedEdge=null;canvas.style.cursor='default'});canvas.addEventListener('mouseleave',function(){isDragging=false;draggedEdge=null;canvas.style.cursor='default'})}else{st.net.setData({nodes:st.nodes,edges:st.edges})}upS();document.getElementById('canvasPlaceholder').style.display='none'});
function findNearestEdge(pos){var minDist=50;var nearest=null;st.edges.get().forEach(function(edge){var fromPos=st.net.getPosition(edge.from);var toPos=st.net.getPosition(edge.to);var dist=distanceToSegment(pos,fromPos,toPos);if(dist<minDist){minDist=dist;nearest=edge.id}});return nearest}
function distanceToSegment(p,v,w){var l2=(v.x-w.x)*(v.x-w.x)+(v.y-w.y)*(v.y-w.y);if(l2===0)return Math.sqrt((p.x-v.x)*(p.x-v.x)+(p.y-v.y)*(p.y-v.y));var t=((p.x-v.x)*(w.x-v.x)+(p.y-v.y)*(w.y-v.y))/l2;t=Math.max(0,Math.min(1,t));var px=v.x+t*(w.x-v.x);var py=v.y+t*(w.y-v.y);return Math.sqrt((p.x-px)*(p.x-px)+(p.y-py)*(p.y-py))}
document.getElementById('zoomInBtn').addEventListener('click',function(){if(st.net){var scale=st.net.getScale();st.net.moveTo({scale:scale*1.2,animation:{duration:300,easingFunction:'easeInOutQuad'}})}});
document.getElementById('zoomOutBtn').addEventListener('click',function(){if(st.net){var scale=st.net.getScale();st.net.moveTo({scale:scale*0.8,animation:{duration:300,easingFunction:'easeInOutQuad'}})}});
document.getElementById('zoomResetBtn').addEventListener('click',function(){if(st.net){st.net.fit({animation:{duration:500,easingFunction:'easeInOutQuad'}})}});
function openM(id){var n=st.nodes.get(id);st.cur=n;document.getElementById('nodeName').value=n.name||'';document.getElementById('nodeFlavor').value=n.flavor||'f1';document.getElementById('nodeInternet').checked=n.internet||false;document.getElementById('nodeModal').style.display='flex'}
document.getElementById('closeModal').addEventListener('click',function(){document.getElementById('nodeModal').style.display='none'});
document.getElementById('cancelNodeBtn').addEventListener('click',function(){document.getElementById('nodeModal').style.display='none'});
document.getElementById('saveNodeBtn').addEventListener('click',function(){if(st.cur){var id=st.cur.id,nm=document.getElementById('nodeName').value||'node-'+id,fl=document.getElementById('nodeFlavor').value,it=document.getElementById('nodeInternet').checked;st.nodes.update({id:id,label:nm,name:nm,flavor:fl,internet:it,configured:true,color:{background:'#10b981',border:'#059669'},font:{color:'#fff'}});upS();document.getElementById('nodeModal').style.display='none'}});
function upS(){var a=st.nodes.get(),c=a.filter(function(x){return x.configured}).length,t=a.length,b=document.getElementById('statusInfo'),d=document.getElementById('deployBtn');if(t===0){b.innerHTML='<p class="muted">Selecciona topolog√≠a</p>';d.disabled=true}else if(c<t){b.innerHTML='<p class="warning">‚ö†Ô∏è '+c+'/'+t+'</p>';d.disabled=true}else{b.innerHTML='<p class="success">‚úÖ '+t+'/'+t+'</p>';d.disabled=false}}
document.getElementById('deployBtn').addEventListener('click',function(){var a=st.nodes.get();if(!a.every(function(x){return x.configured})){alert('‚ö†Ô∏è Completar configuraci√≥n');return}var p={name:st.name,topology:st.sel,vms:a.map(function(n){return{name:n.name,flavor_key:n.flavor,flavor:fm[n.flavor],internet:n.internet}})};sendData(p)});
function sendData(p){var fd=new FormData();fd.append('slice_data',JSON.stringify(p));fetch(createUrl,{method:'POST',body:fd}).then(function(r){if(r.ok)window.location.href=indexUrl;else alert('Error')}).catch(function(e){console.error(e);alert('Error')})}
upS();
