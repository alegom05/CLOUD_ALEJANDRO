var st={sel:null,n:4,name:'slice-1',nodes:new vis.DataSet(),edges:new vis.DataSet(),cur:null,net:null};
var fm={'f1':{cores:1,disk_gb:10,ram_gb:2},'f2':{cores:1,disk_gb:10,ram_gb:4},'f3':{cores:2,disk_gb:10,ram_gb:2},'f4':{cores:2,disk_gb:10,ram_gb:4}};
var tp={
  anillo:function(n){var ns=[],es=[];for(var i=0;i<n;i++){ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true}});es.push({from:i,to:(i+1)%n,smooth:{type:'curvedCW',roundness:0.2}})}return{nodes:ns,edges:es}},
  arbol:function(n){var ns=[],es=[];for(var i=0;i<n;i++){ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true}});if(i>0)es.push({from:Math.floor((i-1)/2),to:i,smooth:{type:'curvedCW',roundness:0.2}})}return{nodes:ns,edges:es}},
  malla:function(n){var ns=[],es=[];for(var i=0;i<n;i++){ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true}});for(var j=i+1;j<n;j++)es.push({from:i,to:j,smooth:{type:'curvedCW',roundness:0.2}})}return{nodes:ns,edges:es}},
  estrella:function(n){var ns=[],es=[];for(var i=0;i<n;i++){ns.push({id:i,label:'üíª\nnode-'+i,configured:false,name:null,flavor:null,internet:false,shape:'box',color:{background:'#e2e8f0',border:'#94a3b8',highlight:{background:'#cbd5e1',border:'#64748b'}},font:{color:'#475569',size:12,multi:true}});if(i>0)es.push({from:0,to:i,smooth:{type:'curvedCW',roundness:0.2}})}return{nodes:ns,edges:es}}
};
document.getElementById('topologySelect').addEventListener('change',function(){st.sel=this.value});
document.getElementById('addTopologyBtn').addEventListener('click',function(){st.sel=document.getElementById('topologySelect').value;if(!st.sel){alert('Selecciona una topolog√≠a');return}st.n=parseInt(document.getElementById('numNodes').value);st.name=document.getElementById('sliceName').value||'slice-1';var t=tp[st.sel](st.n);st.nodes.clear();st.edges.clear();st.nodes.add(t.nodes);st.edges.add(t.edges);if(!st.net){var c=document.getElementById('network');st.net=new vis.Network(c,{nodes:st.nodes,edges:st.edges},{nodes:{shape:'box',size:30,font:{size:14,color:'#1e293b',multi:true},borderWidth:3,borderWidthSelected:4,margin:{top:8,bottom:8,left:10,right:10}},edges:{width:3,color:{color:'#94a3b8',highlight:'#64748b'},smooth:{type:'curvedCW',roundness:0.2}},physics:{enabled:true,stabilization:{iterations:200},barnesHut:{gravitationalConstant:-8000,springConstant:0.04,springLength:150}},interaction:{hover:true,tooltipDelay:200}});st.net.on('click',function(p){if(p.nodes.length>0)openM(p.nodes[0])})}upS();document.getElementById('canvasPlaceholder').style.display='none'});
function openM(id){var n=st.nodes.get(id);st.cur=n;document.getElementById('nodeName').value=n.name||'';document.getElementById('nodeFlavor').value=n.flavor||'f1';document.getElementById('nodeInternet').checked=n.internet||false;document.getElementById('nodeModal').style.display='flex'}
document.getElementById('closeModal').addEventListener('click',function(){document.getElementById('nodeModal').style.display='none'});
document.getElementById('cancelNodeBtn').addEventListener('click',function(){document.getElementById('nodeModal').style.display='none'});
document.getElementById('saveNodeBtn').addEventListener('click',function(){if(st.cur){var id=st.cur.id,nm=document.getElementById('nodeName').value||'node-'+id,fl=document.getElementById('nodeFlavor').value,it=document.getElementById('nodeInternet').checked;st.nodes.update({id:id,label:nm,name:nm,flavor:fl,internet:it,configured:true,color:{background:'#10b981',border:'#059669'},font:{color:'#fff'}});upS();document.getElementById('nodeModal').style.display='none'}});
function upS(){var a=st.nodes.get(),c=a.filter(function(x){return x.configured}).length,t=a.length,b=document.getElementById('statusInfo'),d=document.getElementById('deployBtn');if(t===0){b.innerHTML='<p class="muted">Selecciona topolog√≠a</p>';d.disabled=true}else if(c<t){b.innerHTML='<p class="warning">‚ö†Ô∏è '+c+'/'+t+'</p>';d.disabled=true}else{b.innerHTML='<p class="success">‚úÖ '+t+'/'+t+'</p>';d.disabled=false}}
document.getElementById('deployBtn').addEventListener('click',function(){var a=st.nodes.get();if(!a.every(function(x){return x.configured})){alert('‚ö†Ô∏è Completar configuraci√≥n');return}var p={name:st.name,topology:st.sel,vms:a.map(function(n){return{name:n.name,flavor_key:n.flavor,flavor:fm[n.flavor],internet:n.internet}})};sendData(p)});
function sendData(p){var fd=new FormData();fd.append('slice_data',JSON.stringify(p));fetch(createUrl,{method:'POST',body:fd}).then(function(r){if(r.ok)window.location.href=indexUrl;else alert('Error')}).catch(function(e){console.error(e);alert('Error')})}
upS();
